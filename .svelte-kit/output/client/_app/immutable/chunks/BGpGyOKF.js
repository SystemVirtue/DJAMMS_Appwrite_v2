var u=Object.defineProperty;var g=(a,e,n)=>e in a?u(a,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):a[e]=n;var r=(a,e,n)=>g(a,typeof e!="symbol"?e+"":e,n);function o(a="",e=36){const n=Date.now().toString().slice(-8),t=Math.random().toString(36).substr(2,6),s=a?`${a}-${n}-${t}`:`${n}-${t}`;return s.length>e?s.substring(0,e):s}const c={dashboard:()=>o("dash"),player:()=>o("play"),queue:()=>o("queue"),playlist:()=>o("list"),admin:()=>o("admin"),tab:()=>o("tab"),window:()=>o("win"),session:()=>o("sess"),background:()=>o("bg"),user:()=>o("usr"),queueManagerTab:()=>o("qtab")},d=class d{constructor(){r(this,"broadcastChannel",null);r(this,"openWindows",new Map);r(this,"currentEndpoint","");r(this,"currentTabId","");this.currentTabId=this.generateTabId(),this.setupBroadcastChannel(),this.setupBeforeUnloadHandler(),this.registerCurrentWindow(),this.startPeriodicCleanup()}static getInstance(){return d.instance||(d.instance=new d),d.instance}generateTabId(){return c.tab()}setupBroadcastChannel(){try{this.broadcastChannel=new BroadcastChannel("djamms-window-manager"),this.broadcastChannel.addEventListener("message",this.handleMessage.bind(this))}catch(e){console.warn("Failed to setup window manager broadcast channel:",e)}}handleMessage(e){var s,i;const{type:n,payload:t}=e.data;switch(n){case"window-opened":this.openWindows.set(t.endpoint,t);break;case"window-closed":this.openWindows.delete(t.endpoint),this.clearEndpointFlag(t.endpoint);break;case"window-focus-request":t.endpoint===this.currentEndpoint&&(window.focus(),window.scrollTo(0,0),setTimeout(()=>{window.focus(),document.body.focus()},50),(s=this.broadcastChannel)==null||s.postMessage({type:"window-focused",payload:{endpoint:this.currentEndpoint}}));break;case"ping-windows":this.broadcastWindowInfo();break;case"instance-check":t.endpoint===this.currentEndpoint&&((i=this.broadcastChannel)==null||i.postMessage({type:"instance-exists",payload:{endpoint:this.currentEndpoint,tabId:this.currentTabId}}));break}}setupBeforeUnloadHandler(){window.addEventListener("beforeunload",()=>{this.unregisterCurrentWindow()})}startPeriodicCleanup(){setInterval(()=>{this.cleanupClosedWindows()},5e3)}cleanupClosedWindows(){var e;for(const[n,t]of this.openWindows.entries())t.window&&t.window.closed&&(console.log(`Cleaning up closed window for ${n}`),this.openWindows.delete(n),this.clearEndpointFlag(n),(e=this.broadcastChannel)==null||e.postMessage({type:"window-closed",payload:{endpoint:n}}))}registerCurrentWindow(){this.currentEndpoint=window.location.pathname,this.setEndpointFlag(this.currentEndpoint);const e={id:c.window(),endpoint:this.currentEndpoint,window,opened:Date.now(),tabId:this.currentTabId};this.openWindows.set(this.currentEndpoint,e),this.broadcastWindowOpened(e)}unregisterCurrentWindow(){this.broadcastChannel&&this.broadcastChannel.postMessage({type:"window-closed",payload:{endpoint:this.currentEndpoint}}),this.clearEndpointFlag(this.currentEndpoint),this.openWindows.delete(this.currentEndpoint)}setEndpointFlag(e){try{sessionStorage.setItem(`djamms-open-${e}`,this.currentTabId)}catch(n){console.warn("Failed to set endpoint flag:",n)}}clearEndpointFlag(e){try{sessionStorage.getItem(`djamms-open-${e}`)===this.currentTabId&&sessionStorage.removeItem(`djamms-open-${e}`)}catch(n){console.warn("Failed to clear endpoint flag:",n)}}isEndpointFlagged(e){try{return sessionStorage.getItem(`djamms-open-${e}`)!==null}catch(n){return console.warn("Failed to check endpoint flag:",n),!1}}broadcastWindowOpened(e){this.broadcastChannel&&this.broadcastChannel.postMessage({type:"window-opened",payload:{id:e.id,endpoint:e.endpoint,opened:e.opened,tabId:e.tabId}})}broadcastWindowInfo(){this.broadcastChannel&&this.broadcastChannel.postMessage({type:"window-opened",payload:{id:c.window(),endpoint:this.currentEndpoint,opened:Date.now(),tabId:this.currentTabId}})}pingAllWindows(){this.broadcastChannel&&this.broadcastChannel.postMessage({type:"ping-windows",payload:{}})}async checkInstanceExists(e){return this.isEndpointFlagged(e)&&(console.log(`${e} flagged as open in sessionStorage`),this.broadcastChannel)?new Promise(n=>{const t=setTimeout(()=>{console.log(`No response for ${e} - may be stale flag`),this.clearEndpointFlag(e),n(!1)},200),s=i=>{var w;const{type:h,payload:p}=i.data;h==="instance-exists"&&p.endpoint===e&&(clearTimeout(t),(w=this.broadcastChannel)==null||w.removeEventListener("message",s),n(!0))};this.broadcastChannel&&(this.broadcastChannel.addEventListener("message",s),this.broadcastChannel.postMessage({type:"instance-check",payload:{endpoint:e}}))}):!1}focusWindow(e){console.log(`Attempting to focus existing window for ${e}`);const n=this.openWindows.get(e);if(n&&n.window&&!n.window.closed)try{n.window.focus();const t=n.window;t.moveToFront&&t.moveToFront(),setTimeout(()=>{n.window&&!n.window.closed&&n.window.focus()},100),console.log(`Successfully focused window for ${e}`)}catch(t){console.warn("Failed to focus window directly:",t)}this.broadcastChannel&&this.broadcastChannel.postMessage({type:"window-focus-request",payload:{endpoint:e}}),setTimeout(()=>{if(n&&n.window&&!n.window.closed)try{const t=new Event("focus",{bubbles:!0});n.window.dispatchEvent(t)}catch(t){console.warn("Failed to dispatch focus event:",t)}},200)}async openEndpoint(e){if(console.log(`Attempting to open ${e}`),await this.checkInstanceExists(e))return console.log(`${e} already open - focusing existing window`),this.focusWindow(e),!1;{console.log(`Opening new window for ${e}`);const t=window.location.origin+e,s=window.open(t,"_blank",this.getWindowFeatures(e));if(s){const i={id:c.window(),endpoint:e,window:s,opened:Date.now(),tabId:c.tab()};return this.openWindows.set(e,i),this.setEndpointFlag(e),this.broadcastWindowOpened(i),!0}else return!1}}getWindowFeatures(e){const n="resizable=yes,scrollbars=yes,status=yes,toolbar=no,menubar=no";switch(e){case"/videoplayer":return`${n},width=1280,height=720,left=100,top=100`;case"/queuemanager":return`${n},width=1000,height=800,left=200,top=150`;case"/playlistlibrary":return`${n},width=1200,height=900,left=150,top=100`;case"/dashboard":case"/adminconsole":return`${n},width=1100,height=850,left=250,top=200`;default:return`${n},width=1024,height=768`}}getOpenWindows(){const e=[];for(const[n,t]of this.openWindows.entries())e.push({endpoint:n,opened:new Date(t.opened).toLocaleString(),tabId:t.tabId,isCurrentWindow:n===this.currentEndpoint});return e}isWindowOpen(e){const n=this.openWindows.get(e);return n?n.window&&n.window.closed?(this.openWindows.delete(e),this.clearEndpointFlag(e),!1):this.isEndpointFlagged(e):!1}shouldPreventDuplicate(){const e=window.location.pathname;if(!["/videoplayer","/queuemanager","/playlistlibrary","/dashboard","/adminconsole"].includes(e))return!1;const t=sessionStorage.getItem(`djamms-open-${e}`);return t!==null&&t!==this.currentTabId}};r(d,"instance");let l=d;const f=l.getInstance();export{c as I,f as w};
